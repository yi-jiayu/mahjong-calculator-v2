<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="config-tab">

    <template>
        <style include="shared-styles"></style>
        <style>
            /* CSS rules for your element */
            .title {
                font-size: 18px;
                font-weight: 500;
            }
        </style>

        <!-- local DOM for your element -->
        <iron-ajax id="ajaxCreate" url="http://localhost:8080/api" method="post" handle-as="text"
                   last-response="{{sessionId}}" verbose="true"></iron-ajax>

        <iron-ajax auto id="ajaxUpdate" url="[[sessionUrl]]" handle-as="json" last-response="{{mahjongUpdate}}"
                   verbose="true"></iron-ajax>

        <template is="dom-if" if="[[!existsActiveSession]]">
            <paper-material>
                <div class="title">Create new session</div>
                    <paper-input label="Session Name" value="{{sessionName}}"></paper-input>
                <div class="layout horizontal end-justified">
                    <paper-button raised on-tap="getSessionId">Create</paper-button>
                </div>
            </paper-material>
        </template>

        <template is="dom-if" if="[[existsActiveSession]]">
            <paper-material>
                <div class="title">Session Info</div>
                <paper-item disabled="true">
                    <paper-item-body two-line>
                        <div secondary>Session ID</div>
                        <div>[[sessionId]]</div>
                    </paper-item-body>
                </paper-item>
            </paper-material>
            <paper-material>
                <div class="title">Players</div>

                <template is="dom-repeat" items="{{sessionData}}">
                    <paper-item disabled="true">
                        <paper-item-body two-line>
                            <div secondary>[[item.epithet]]</div>
                            <div>[[item.name]]</div>
                        </paper-item-body>
                    </paper-item>
                </template>

            </paper-material>
        </template>
    </template>


    <script>
        // element registration
        Polymer({
            is: 'config-tab',

            // add properties and methods on the element's prototype
            properties: {
                // declare properties for the element's public API
                ajaxResponse: {
                    type: String,
                    value: 'default value'
                },

                sessionId: {
                    type: String
                },

                existsActiveSession: {
                    type: Boolean,
                    value: false,
                    computed: 'checkSession(sessionId)'
                },

                sessionUrl: {
                    type: String,
                    computed: 'computeSessionUrl(sessionId)'
                },

                sessionData: {
                    type: Array,
                    computed: 'parseUpdate(mahjongUpdate)',
                    notify: true
                }
            },

            checkSession: function (sessionId) {
                return (sessionId !== '');
            },

            computeSessionUrl: function(sessionId) {
                return 'http://localhost:8080/api/' + sessionId;
            },

            getSessionId: function () {
                this.$.ajaxCreate.body = 'name=' + this.sessionName;
                this.$.ajaxCreate.generateRequest();
            },

            parseUpdate: function(mahjongUpdate) {
                if (mahjongUpdate) {
                    var sessionData = [];
                    for (var i = 0; i < 4; i++) {
                        sessionData.push({'name': mahjongUpdate.playerNames[i], 'epithet': mahjongUpdate.playerEpithets[i], 'score': mahjongUpdate.scores[i]});
                    }
                    return sessionData;
                }
            }
        });
    </script>
</dom-module>
